mx = include_lib("/lib/metaxploit.so")
if not mx then mx = include_lib(parent_path(program_path) + "/metaxploit.so")
if not mx then exit("Cannot find metaxploit.so")

ScanLib = function(metalib, metax)
    if not metalib then return null
    if not metax then return null

    ret = {}
    ret.memorys = {}

    memorys = metax.scan(metalib)
    if typeof(memorys) != "list" then return null

    for memory in memorys
        ret.memorys[memory] = []

        data = mx.scan_address(metalib, memory)
        if typeof(data) != "string" then continue

        parts = data.split("Unsafe check: ")
        for p in parts
            if p == parts[0] then continue

            // extract unsafe value from <b>...</b>
            if p.indexOf("<b>") == null then continue
            if p.indexOf("</b>") == null then continue

            value = p[p.indexOf("<b>")+3 : p.indexOf("</b>")]
            ret.memorys[memory].push(value)
        end for
    end for

    return ret
end function


ExploitTarget = function(targetIP, targetPort, injectArg="")
    objects = []

    ns = mx.net_use(targetIP, targetPort)
    if not ns then
        print("Cannot connect to net session.")
        return objects
    end if

    lib = ns.dump_lib
    if not lib then
        print("Cannot dump library.")
        return objects
    end if

    exploits = ScanLib(lib, mx)
    if not exploits then return objects

    for memory in exploits.memorys
        memAddr = memory.key
        values = memory.value

        for value in values
            result = lib.overflow(memAddr, value, injectArg)

            if typeof(result) != "shell" and typeof(result) != "computer" and typeof(result) != "file" then
                continue
            end if

            objects.push(result)
        end for
    end for

    return objects
end function